<form class="pf2e-autoloot-settings"
      style="display:flex; flex-direction:column; height:100%;">

  {{!-- HEADER: tabs fijas --}}
  <nav class="pf2e-autoloot-tabs"
       style="flex:0 0 auto; display:flex; gap:8px; padding:8px 10px; z-index:2;">
    {{#each categories as |cat|}}
      <button type="button"
              class="tab {{#if cat.active}}active{{/if}}"
              data-action="switchGroup"
              data-key="{{cat.key}}"
              style="padding:6px 10px; border-radius:6px; border:1px solid var(--color-border-light-primary);
                     {{#if cat.active}}background: rgba(100,150,255,0.15); font-weight:700;{{/if}}">
        {{cat.title}}
      </button>
    {{/each}}
  </nav>

  {{!-- BODY: solo aquí hay scroll --}}
  <div class="pf2e-autoloot-body"
       style="flex:1 1 auto; overflow:auto; padding:10px 6px 12px 10px; position:relative;">

    {{!-- Sección dinámica para las pestañas que usan "groups" --}}
    {{#if (or (eq activeGroupKey "General") (eq activeGroupKey "Compendia") (eq activeGroupKey "Advanced") (eq activeGroupKey "Containers"))}}
      {{#each groups as |group|}}
        <fieldset style="margin-top:10px; border-radius:8px; padding:8px;">
          <legend style="font-weight:700; letter-spacing:.2px; padding:0 4px;">{{group.title}}</legend>

          {{#each group.items as |item|}}
            {{#if (eq item.inputType "checkbox")}}
              <div class="pv-form-row"
                   style="margin-bottom: 10px; display:flex; align-items:center; justify-content:space-between; gap:12px;
                          border-bottom:1px solid #6868684d; padding:6px 0;">
                <div style="flex:1 1 auto;">
                  <label>{{item.name}}</label>
                  {{#if item.hint}}<div class="notes" style="opacity:.8;">{{item.hint}}</div>{{/if}}
                </div>
                <div style="flex:0 0 auto; display:flex; align-items:center;">
                  <input type="checkbox" name="settings.{{item.key}}" {{#if item.value}}checked{{/if}}>
                </div>
              </div>

            {{else if (eq item.ui "range")}}
              <div class="pv-form-row"
                   style="margin-bottom: 10px; border-bottom:1px solid #6868684d; padding:6px 0;">
                <label>{{item.name}}</label>
                {{#if item.hint}}<div class="notes" style="opacity:.8;">{{item.hint}}</div>{{/if}}

                <div style="display:flex; align-items:center; gap:8px;">
                  <span style="flex:0 0 auto; font-size:12px; opacity:.7;">{{item.min}}</span>
                  <input type="range"
                         name="settings.{{item.key}}"
                         min="{{item.min}}" max="{{item.max}}" step="{{item.step}}"
                         value="{{item.value}}"
                         style="flex:1 1 auto;">
                  <span class="tt-slider-value" data-key="{{item.key}}"
                        style="flex:0 0 auto; width:44px; text-align:right;">{{item.value}}</span>
                </div>
              </div>

            {{else if (eq item.inputType "select")}}
              <div class="pv-form-row"
                   style="margin-bottom: 10px; border-bottom:1px solid #6868684d; padding:6px 0;">
                <label>{{item.name}}</label>
                {{#if item.hint}}<div class="notes" style="opacity:.8;">{{item.hint}}</div>{{/if}}
                <select name="settings.{{item.key}}">
                  {{#each item.choices as |opt|}}
                    <option value="{{opt.value}}"
                      {{#if (eq ../value opt.value)}}selected{{/if}}>
                      {{opt.label}}
                    </option>
                  {{/each}}
                </select>
              </div>

            {{else}}
              <div class="pv-form-row"
                   style="margin-bottom: 10px; border-bottom:1px solid #6868684d; padding:6px 0;">
                <label>{{item.name}}</label>
                {{#if item.hint}}<div class="notes" style="opacity:.8;">{{item.hint}}</div>{{/if}}
                {{#if (eq item.inputType "number")}}
                  <input type="number" name="settings.{{item.key}}"
                         value="{{item.value}}" min="{{item.min}}" max="{{item.max}}" step="{{item.step}}">
                {{else}}
                  <input type="text" name="settings.{{item.key}}" value="{{item.value}}">
                {{/if}}
              </div>
            {{/if}}
          {{/each}}
        </fieldset>
      {{/each}}
    {{/if}}

    {{!-- Panel de acciones específicas (solo Advanced) --}}
    {{#if (eq activeGroupKey "Advanced")}}
      <fieldset style="margin-top:10px; border-radius:8px; padding:8px;">
        <legend style="font-weight:700; letter-spacing:.2px; padding:0 4px;">
          {{localize "Actions"}}
        </legend>
        <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:8px;">
          <button type="button" data-action="preload-cache"
                  style="flex:1 1 auto; padding:6px 10px; border-radius:6px; border:1px solid var(--color-border-light-primary);">
            <i class="fas fa-download" style="margin-right:6px;"></i>
            {{localize "pf2e-autoloot.settings.preloadOnReady.name"}}
          </button>

          <button type="button" data-action="clear-unique-registry"
                  style="flex:1 1 auto; padding:6px 10px; border-radius:6px; border:1px solid var(--color-border-light-primary);">
            <i class="fas fa-broom" style="margin-right:6px;"></i>
            {{localize "pf2e-autoloot.settings.uniqueRegistryJson.name"}}
          </button>
        </div>
      </fieldset>
    {{/if}}


    {{!-- ======================= --}}
{{!-- Pestaña Custom --}}
{{!-- ======================= --}}
{{#if (eq activeGroupKey "Custom")}}
  <fieldset style="margin-top:10px; border-radius:8px; padding:8px;">
    <legend style="font-weight:700; letter-spacing:.2px; padding:0 4px;">
      {{localize "pf2e-autoloot.settings.custom.title"}}
    </legend>

    <div style="display:flex; gap:8px; margin:6px 0 12px;">
      <button type="button" data-action="add-custom-container"
              style="padding:6px 10px; border-radius:6px; border:1px solid var(--color-border-light-primary);">
        <i class="fas fa-plus-circle" style="margin-right:6px;"></i>
        {{localize "pf2e-autoloot.settings.custom.add"}}
      </button>
    </div>

    {{#if (not customContainers.length)}}
      <div class="notes" style="opacity:.8;">{{localize "pf2e-autoloot.settings.custom.empty"}}</div>
    {{/if}}

    <div class="custom-containers">
    {{#each customContainers as |c|}}
      <fieldset class="custom-container" data-custom-id="{{c.id}}" data-custom-name="{{c.name}}" style="margin-top:10px; border-radius:8px; padding:8px;">
        <legend style="font-weight:700; letter-spacing:.2px; padding:0 4px;">{{c.name}}</legend>

        <div class="pv-form-row" style="margin-bottom:8px; border-bottom:1px solid #6868684d; padding:6px 0;">
          <label>{{localize "Name"}}</label>
          <input type="text" name="custom.{{c.id}}.name" value="{{c.name}}">
        </div>

        <div class="pv-form-row" style="margin-bottom:8px; border-bottom:1px solid #6868684d; padding:6px 0;">
          <label>{{localize "pf2e-autoloot.settings.custom.patterns.name"}}</label>
          <div class="notes" style="opacity:.8;">{{localize "pf2e-autoloot.settings.custom.patterns.hint"}}</div>
          <input type="text" name="custom.{{c.id}}.patterns" value="{{c.patterns}}" placeholder="Cofre Antiguo, Chest, Arca">
        </div>

        <div class="pv-form-row" style="margin-bottom:8px; border-bottom:1px solid #6868684d; padding:6px 0;">
        <label>{{localize "pf2e-autoloot.settings.custom.categories.name"}}</label>
        <div class="notes" style="opacity:.8;">{{localize "pf2e-autoloot.settings.custom.categories.hint"}}</div>

        <input type="text"
                data-tagify="filters"
                data-id="{{c.id}}"
                name="custom.{{c.id}}.filters"
                value='{{c.filtersJson}}'
                placeholder="Type to search and click or press Enter (e.g., armor, axe, alchemical items, etc.)">
        </div>


        <div class="pv-form-row" style="margin-bottom:8px; border-bottom:1px solid #6868684d; padding:6px 0;">
          <label>{{localize "pf2e-autoloot.settings.custom.emptyChance.name"}}</label>
          <div class="notes" style="opacity:.8;">{{localize "pf2e-autoloot.settings.custom.emptyChance.hint"}}</div>
          <div style="display:flex; align-items:center; gap:8px;">
            <span style="flex:0 0 auto; font-size:12px; opacity:.7;">0%</span>
            <input type="range" name="custom.{{c.id}}.emptyChance" min="0" max="100" step="1" value="{{c.emptyChance}}" style="flex:1 1 auto;">
            <span style="flex:0 0 auto; font-size:12px; opacity:.7;">100%</span>
          </div>
        </div>

        <div class="pv-form-row" style="margin-bottom:8px; border-bottom:1px solid #6868684d; padding:6px 0;">
          <label>{{localize "pf2e-autoloot.settings.custom.countRange.name"}}</label>
          <div class="notes" style="opacity:.8;">{{localize "pf2e-autoloot.settings.custom.countRange.hint"}}</div>
          <input type="text" name="custom.{{c.id}}.countRange" value="{{c.countRange}}" placeholder="1, 5" style="width:120px;">
        </div>

        <div style="display:flex; gap:8px; justify-content:flex-end;">
          <button type="button" class="danger" data-action="remove-custom-container" data-id="{{c.id}}"
                  style="padding:6px 10px; border-radius:6px; border:1px solid var(--color-border-light-primary);">
            <i class="fas fa-trash" style="margin-right:6px;"></i>
            {{localize "Delete"}}
          </button>
        </div>
      </fieldset>
    {{/each}}
    </div>
  </fieldset>
{{/if}}

  </div>

  {{!-- Footer: Guardar / Cerrar --}}
  <footer style="flex:0 0 auto; display:flex; gap:8px; justify-content:center;
                 border-top:1px solid var(--color-border-light-primary);
                 padding:10px; background:var(--color-bg-primary); z-index:2;">
    <button type="button" data-action="submit" class="pf2e-autoloot-save">{{localize "Save"}}</button>
    <button type="button" data-action="closeApp">{{localize "Close"}}</button>
  </footer>
</form>
